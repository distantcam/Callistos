local versionNumber = 0.1

local function resetScreen()
	term.clear()
	term.setCursorPos(1,1)
	xlim, ylim = term.getSize()
	if xlim >= 20 then
		term.write("=SpaceOS Installer"..string.rep("=", xlim - 18))
		term.setCursorPos(1,2)
	end
end

local function downloadFile(url, filePath)
	local remoteHandle = http.get(url)
	if remoteHandle then
		fileHandle = io.open(filePath, "w")
		if fileHandle then
			fileHandle:write(remoteHandle.readAll())
			fileHandle:close()
		else
			error("Could not open file "..filePath)
		end
	else
		error("Could not retrieve remote file.")
	end
end

local function downloadGitHubDirectory(url, dirPath)
	local remoteHandle = http.get(url)

	if remotehandle == nil then
		error("Could not retrieve directory.")
		return
	end

	local text = remoteHandle.readAll()

	local result = json.decode(text)

	for k,v in pairs(result) do
		if v["type"] == "dir" then
			if not fs.exists(dirPath..v["name"]) then
				fs.makeDir(dirPath..v["name"])
			end
			downloadGitHubDirectory(v["url"], dirPath..v["name"])
		end
	end

end

-- End Functions

if not http then
	printError( "SpaceOS installer requires http API" )
	printError( "Set enableAPI_http to true in ComputerCraft.cfg" )
	return
end

local args = {...}

local osPath = "/SpaceOS"

if #args == 1 and (args[1] == "remove" or args[1] == "-r") then
	if fs.exists(osPath) then
		fs.delete(osPath)
	end
	return
end

resetScreen()

if not fs.exists(osPath) or not fs.isDir(osPath) then
	fs.makeDir(osPath)
end

if #args < 1 or (args[1] ~= "noupdate") then
	downloadFile("https://raw.github.com/distantcam/SpaceOS/master/installer", shell.getRunningProgram())
	local fileHandle = io.open(shell.getRunningProgram(), "r")
	if fileHandle then
		local newVersionNumber = tonumber(string.match(fileHandle:read("*l"), "local versionNumber = (.*)"))
		fileHandle:close()
		if newVersionNumber > versionNumber then
			shell.run(shell.getRunningProgram(), "noupdate")
			return
		end
	end
	resetScreen()
end

-- TODO Install Files
if not fs.exists(osPath.."/apis") then fs.makeDir(osPath.."/apis") end
if not fs.exists(osPath.."/apis/json") then
	downloadFile("https://raw.github.com/distantcam/SpaceOS/master/SpaceOS/apis/json", osPath.."/apis/json")
end
os.loadAPI(osPath.."/apis/json")

downloadGitHubDirectory("https://api.github.com/repos/distantcam/SpaceOS/contents/SpaceOS/", osPath)

-- TODO Install startup script

print("Reboot now? (Y/n)")
term.write("> ")
input = read()
if #input > 0 then
	input = string.lower(string.sub(input, 1, 1))
	if input == "y" then
		os.reboot()
	end
else
	os.reboot()
end

term.clear()
term.setCursorPos(1,1)