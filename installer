local versionNumber = 0.5

local args = {...}

local osPath = "/Callistos"
local rawURL = "https://raw.github.com/distantcam/Callistos/master/"
local apiURL = "https://api.github.com/repos/distantcam/Callistos/contents/"

local function resetScreen()
    term.clear()
    term.setCursorPos(1,1)
    xlim, ylim = term.getSize()
    if xlim >= 20 then
        term.write("=Callistos Installer"..string.rep("=", xlim - 16))
        term.setCursorPos(1,2)
    end
end

local function downloadFile(url, filePath)
    local remoteHandle = http.get(url)
    if remoteHandle then
        fileHandle = io.open(filePath, "w")
        if fileHandle then
            fileHandle:write(remoteHandle.readAll())
            fileHandle:close()
        else
            error("Could not open file "..filePath)
        end
    else
        error("Could not retrieve remote file.")
    end
end

local function downloadGitHubDirectory(url, dirPath)
    local remoteHandle = http.get(url)

    if remoteHandle == nil then
        error("Could not retrieve directory.")
        return
    end

    local text = remoteHandle.readAll()

    local obj = json.decode(text)

    for i,v in ipairs(obj) do
        if v.type == "dir" then
            if not fs.exists(dirPath..v.name) then
                print("Making directory "..v.path)
                fs.makeDir(dirPath..v.name)
            end
            downloadGitHubDirectory(v.url, dirPath..v.name.."/")
        elseif v.type == "file" then
            if not fs.exists(dirPath..v.name) then
                print("Downloading file "..v.path)
                downloadFile(rawURL..v.path, dirPath..v.name)
            end
        end
    end

end

-- End Functions

if not http then
    printError( "Callistos installer requires http API" )
    printError( "Set enableAPI_http to true in ComputerCraft.cfg" )
    return
end

if #args == 1 and (args[1] == "uninstall" or args[1] == "-u") then
    if fs.exists(osPath) then
        fs.delete(osPath)
    end
    return
end

resetScreen()

if not fs.exists(osPath) or not fs.isDir(osPath) then
    fs.makeDir(osPath)
end

if #args < 1 or (args[1] ~= "noupdate") then
    downloadFile(rawURL.."installer", shell.getRunningProgram())
    local fileHandle = io.open(shell.getRunningProgram(), "r")
    if fileHandle then
        local newVersionNumber = tonumber(string.match(fileHandle:read("*l"), "local versionNumber = (.*)"))
        fileHandle:close()
        if newVersionNumber > versionNumber then
            shell.run(shell.getRunningProgram(), "noupdate")
            return
        end
    end
    resetScreen()
end

if not fs.exists(osPath.."/apis") then fs.makeDir(osPath.."/apis") end
if not fs.exists(osPath.."/apis/json") then
    print("Downloading JSON api")
    downloadFile(rawURL.."Callistos/apis/json", osPath.."/apis/json")
end
os.loadAPI(osPath.."/apis/json")

downloadGitHubDirectory(apiURL.."Callistos/", osPath.."/")

print("Run Callistos on startup? (y/N)")
term.write("> ")
local input = read()
if #input > 0 then
    input = string.lower(string.sub(input, 1, 1))
    if input == "y" then
        local handle = io.open("/startup", "a")
        if not handle then -- Append bug in ComputerCraft does not create
            handle = io.open("/startup", "w")
        end
        if handle then
            handle:write([[shell.run("]]..osPath..[[/startup")]].."\n")
            handle:close()
        end
    end
end

print("Reboot now? (Y/n)")
term.write("> ")
input = read()
if #input > 0 then
    input = string.lower(string.sub(input, 1, 1))
    if input == "y" then
        os.reboot()
    end
else
    os.reboot()
end

term.clear()
term.setCursorPos(1,1)